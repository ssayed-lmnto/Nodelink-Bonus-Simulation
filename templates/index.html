<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nodelink - Node Growth Payout Simulator</title>
    <style>
        :root {
            --bg: #fbfbfd;
            --bg-secondary: #f5f5f7;
            --white: #ffffff;
            --text: #1d1d1f;
            --text-secondary: #86868b;
            --border: #d2d2d7;
            --blue: #0071e3;
            --green: #34c759;
            --orange: #ff9500;
            --red: #ff3b30;
            --purple: #af52de;
            --teal: #5ac8fa;
            --shadow: 0 2px 8px rgba(0,0,0,0.04), 0 4px 24px rgba(0,0,0,0.06);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --radius: 12px;
            --radius-lg: 18px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 48px 24px; }

        /* Header */
        header { text-align: center; margin-bottom: 40px; }
        h1 { font-size: 40px; font-weight: 600; letter-spacing: -0.5px; margin-bottom: 8px; }
        .subtitle { font-size: 17px; color: var(--text-secondary); }

        /* Page Navigation */
        .page-nav {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: 12px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .page-nav-btn {
            padding: 10px 28px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-nav-btn:hover { color: var(--text); }
        .page-nav-btn.active {
            background: var(--white);
            color: var(--text);
            box-shadow: var(--shadow-sm);
        }

        .page { display: none; }
        .page.active { display: block; }

        /* Layout */
        .layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 32px;
            align-items: start;
        }
        @media (max-width: 900px) {
            .layout { grid-template-columns: 1fr; }
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--bg-secondary);
        }
        .card-header h3 { font-size: 17px; font-weight: 600; }
        .card-body { padding: 24px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab:hover { color: var(--text); }
        .tab.active {
            background: var(--white);
            color: var(--text);
            box-shadow: var(--shadow-sm);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Forms */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-input:focus { outline: none; border-color: var(--blue); }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px 24px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
        }
        .btn:hover { background: #0077ed; }
        .btn:disabled { background: var(--border); cursor: not-allowed; }

        /* Info Box */
        .info-box {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .info-box.blue { background: linear-gradient(135deg, rgba(0,113,227,0.08), rgba(90,200,250,0.08)); border: 1px solid rgba(0,113,227,0.2); }
        .info-box.green { background: linear-gradient(135deg, rgba(52,199,89,0.08), rgba(48,209,88,0.08)); border: 1px solid rgba(52,199,89,0.2); }
        .info-box.orange { background: linear-gradient(135deg, rgba(255,149,0,0.08), rgba(255,94,58,0.08)); border: 1px solid rgba(255,149,0,0.2); }
        .info-box.purple { background: linear-gradient(135deg, rgba(175,82,222,0.08), rgba(191,90,242,0.08)); border: 1px solid rgba(175,82,222,0.2); }
        .info-box-title { font-weight: 600; font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .info-box-text { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }

        /* Status */
        .status-bar {
            margin-top: 16px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 10px;
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Results */
        .results { display: none; }
        .results.visible { display: block; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .stats-grid.four { grid-template-columns: repeat(4, 1fr); }
        @media (max-width: 700px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stats-grid.four { grid-template-columns: repeat(2, 1fr); }
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
        .stat-value { font-size: 28px; font-weight: 600; letter-spacing: -0.5px; }
        .stat-value.green { color: var(--green); }
        .stat-value.blue { color: var(--blue); }
        .stat-value.orange { color: var(--orange); }
        .stat-value.purple { color: var(--purple); }
        .stat-sub { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

        /* Tables */
        .table-wrap { overflow-x: auto; }
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            white-space: nowrap;
        }
        .table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--bg-secondary);
            white-space: nowrap;
        }
        .table tr:hover td { background: var(--bg); }
        .table .money { text-align: right; font-family: 'SF Mono', monospace; }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            background: var(--bg-secondary);
        }
        .badge-n1 { background: #e8f5e9; color: #2e7d32; }
        .badge-n2 { background: #e3f2fd; color: #1565c0; }
        .badge-n3 { background: #fff3e0; color: #ef6c00; }
        .badge-n4 { background: #fce4ec; color: #c2185b; }
        .badge-n5 { background: #ede7f6; color: #7b1fa2; }
        .badge-n6 { background: #e0f2f1; color: #00695c; }
        .badge-n7 { background: #ffebee; color: #c62828; }

        /* Rank Numbers */
        .rank-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffb300); color: white; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #9e9e9e); color: white; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: white; }
        .rank-other { background: var(--bg-secondary); color: var(--text-secondary); }

        /* Distribution Bars */
        .dist-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .dist-label { width: 60px; font-size: 12px; font-weight: 500; }
        .dist-bar { flex: 1; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; }
        .dist-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .dist-fill.green { background: var(--green); }
        .dist-fill.blue { background: var(--blue); }
        .dist-value { width: 80px; text-align: right; font-size: 12px; color: var(--text-secondary); }

        /* Chart */
        .chart-container { background: var(--white); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
        .chart-title { font-size: 17px; font-weight: 600; margin-bottom: 20px; }
        .chart-bars { display: flex; align-items: flex-end; gap: 8px; height: 180px; }
        .chart-bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .chart-bar-pair { display: flex; gap: 3px; align-items: flex-end; height: 150px; }
        .chart-bar { width: 20px; border-radius: 4px 4px 0 0; transition: all 0.3s; }
        .chart-bar.inflow { background: var(--blue); }
        .chart-bar.bonus { background: var(--green); }
        .chart-label { font-size: 11px; color: var(--text-secondary); }
        .chart-legend { display: flex; justify-content: center; gap: 24px; margin-top: 16px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 3px; }

        /* Heatmap */
        .heatmap-table { width: 100%; border-collapse: collapse; }
        .heatmap-table th { padding: 10px 8px; font-size: 11px; font-weight: 600; color: var(--text-secondary); }
        .heatmap-cell {
            padding: 12px 8px;
            text-align: center;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: default;
        }
        .heatmap-cell:hover { transform: scale(1.05); }
        .heatmap-pct { font-size: 18px; font-weight: 700; }
        .heatmap-amount { font-size: 11px; margin-top: 2px; }
        .heatmap-users { font-size: 10px; opacity: 0.7; }

        /* Methodology */
        .methodology {
            background: linear-gradient(135deg, rgba(90,200,250,0.08), rgba(0,113,227,0.08));
            border: 1px solid rgba(0,113,227,0.15);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
        }
        .methodology h4 { font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .methodology-item { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.5; }
        .methodology-item strong { color: var(--text); }

        /* Placeholder */
        .placeholder {
            text-align: center;
            padding: 80px 40px;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        .placeholder-icon { font-size: 48px; margin-bottom: 16px; }
        .placeholder h3 { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .placeholder p { color: var(--text-secondary); max-width: 400px; margin: 0 auto; }

        /* Promo highlight */
        .promo-row { background: linear-gradient(90deg, rgba(255,149,0,0.08), transparent); }

        /* Hierarchy Status */
        .hierarchy-status {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .hierarchy-status-title { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
        .hierarchy-status-value { font-size: 20px; font-weight: 600; }
        .hierarchy-status-sub { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Nodelink - Node Growth Payout Simulator</h1>
            <p class="subtitle">Model and analyze compensation plans with scientific precision</p>
        </header>

        <!-- Page Navigation -->
        <div class="page-nav">
            <button class="page-nav-btn active" onclick="showPage('powerup')">‚ö° PowerUp Bonus</button>
            <button class="page-nav-btn" onclick="showPage('direct')">üí∞ Direct Bonus</button>
        </div>

        <!-- ============================================ -->
        <!-- POWERUP BONUS PAGE -->
        <!-- ============================================ -->
        <div class="page active" id="page-powerup">
            <div class="layout">
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="card">
                        <div class="card-body">
                            <div class="tabs">
                                <button class="tab active" onclick="switchTab('pu', 'basic')">Basic</button>
                                <button class="tab" onclick="switchTab('pu', 'ranks')">Ranks</button>
                                <button class="tab" onclick="switchTab('pu', 'powerup')">PowerUp</button>
                                <button class="tab" onclick="switchTab('pu', 'matching')">Matching</button>
                            </div>

                            <!-- Basic Tab -->
                            <div class="tab-content active" id="pu-tab-basic">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Total Users</label>
                                        <input type="number" class="form-input" id="total_users" value="10000">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Max Depth</label>
                                        <input type="number" class="form-input" id="max_depth" value="7">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Avg Units</label>
                                        <input type="number" class="form-input" id="avg_units" value="8">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Min Units</label>
                                        <input type="number" class="form-input" id="min_units" value="1">
                                    </div>
                                </div>

                                <div class="info-box orange">
                                    <div class="info-box-title">üéØ Promotion Adjustment</div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <input type="checkbox" id="promotion_enabled" checked style="width: 16px; height: 16px;">
                                        <span style="font-size: 13px;">Enable promotional push</span>
                                    </div>
                                    <div class="form-row" style="margin-bottom: 0;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Target Units</label>
                                            <input type="number" class="form-input" id="promotion_target" value="8">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Intensity %</label>
                                            <select class="form-input" id="promotion_intensity">
                                                <option value="25">Light (25%)</option>
                                                <option value="30" selected>Moderate (30%)</option>
                                                <option value="45">Aggressive (45%)</option>
                                                <option value="65">Extreme (65%)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="info-box blue">
                                    <div class="info-box-title">‚ö° Hierarchy Cache</div>
                                    <div class="info-box-text">Saves generated tree to CSV for instant reuse.</div>
                                    <div style="display: flex; gap: 16px; margin-top: 8px;">
                                        <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer;">
                                            <input type="checkbox" id="use_cache" checked style="width: 14px; height: 14px;">
                                            Use cache
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer;">
                                            <input type="checkbox" id="force_regenerate" style="width: 14px; height: 14px;">
                                            Force new
                                        </label>
                                    </div>
                                </div>

                                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 12px; margin-top: 12px;">
                                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px;">Line Thresholds</div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">L2 %</label>
                                            <input type="number" class="form-input" id="line_2" value="30">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">L3 %</label>
                                            <input type="number" class="form-input" id="line_3" value="20">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">L4 %</label>
                                            <input type="number" class="form-input" id="line_4" value="10">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">L5 %</label>
                                            <input type="number" class="form-input" id="line_5" value="5">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ranks Tab -->
                            <div class="tab-content" id="pu-tab-ranks">
                                <div class="info-box-text" style="margin-bottom: 16px;">VP required to achieve each rank level</div>
                                <div id="rank-inputs"></div>
                            </div>

                            <!-- PowerUp Tab -->
                            <div class="tab-content" id="pu-tab-powerup">
                                <div class="info-box-text" style="margin-bottom: 16px;">PowerUp % by Rank and Qualified Lines</div>
                                <div id="powerup-matrix"></div>
                            </div>

                            <!-- Matching Tab -->
                            <div class="tab-content" id="pu-tab-matching">
                                <div class="info-box-text" style="margin-bottom: 16px;">Matching bonus % by rank (N3+ only)</div>
                                <div id="matching-inputs"></div>
                            </div>

                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <button class="btn" id="pu-run-btn" onclick="runPowerUp()">üöÄ Run Simulation</button>
                                <button class="btn" id="pu-cancel-btn" onclick="cancelPowerUp()" style="background: var(--orange); display: none;">‚èπ Cancel</button>
                                <button class="btn" id="pu-reset-btn" onclick="forceReset('powerup')" style="background: var(--text-secondary); display: none;">üîÑ Reset</button>
                            </div>
                            <div class="status-bar" id="pu-status" style="display: none;">
                                <span id="pu-status-text">Ready</span>
                                <span id="pu-status-time" style="margin-left: 8px; opacity: 0.8;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="main">
                    <div class="results" id="pu-results">
                        <!-- Methodology -->
                        <div class="methodology">
                            <h4>üìä Scientific Methodology</h4>
                            <div class="methodology-item"><strong>Hierarchy:</strong> Barab√°si‚ÄìAlbert weighted preferential attachment model from network science</div>
                            <div class="methodology-item"><strong>Purchases:</strong> Mixture model - 15% minimum, 55% moderate, 25% above-avg, 5% power buyers (FTC validated)</div>
                            <div class="methodology-item"><strong>PowerUp:</strong> Differential percentage calculation with rank-based caps</div>
                            <div class="methodology-item"><strong>Matching:</strong> Cascading bonus when upline % ‚â§ downline %</div>
                        </div>

                        <!-- Stats -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Users</div>
                                <div class="stat-value" id="pu-stat-users">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Sales</div>
                                <div class="stat-value" id="pu-stat-sales">$0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Payout Ratio</div>
                                <div class="stat-value green" id="pu-stat-ratio">0%</div>
                            </div>
                        </div>

                        <div class="stats-grid four">
                            <div class="stat-card">
                                <div class="stat-label">PowerUp Paid</div>
                                <div class="stat-value green" id="pu-stat-powerup">$0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Matching Paid</div>
                                <div class="stat-value blue" id="pu-stat-matching">$0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Bonuses</div>
                                <div class="stat-value" id="pu-stat-total">$0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Avg VP</div>
                                <div class="stat-value" id="pu-stat-vp">$0</div>
                            </div>
                        </div>

                        <!-- Distributions -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <div class="card">
                                <div class="card-header"><h3>Rank Distribution</h3></div>
                                <div class="card-body" id="pu-rank-dist"></div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3>Line Distribution</h3></div>
                                <div class="card-body" id="pu-line-dist"></div>
                            </div>
                        </div>

                        <!-- Heatmap -->
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header"><h3>PowerUp Payout Heatmap</h3></div>
                            <div class="card-body">
                                <div class="table-wrap" id="pu-heatmap"></div>
                            </div>
                        </div>

                        <!-- Top Earners -->
                        <div class="card">
                            <div class="card-header"><h3>üèÜ Top Earners</h3></div>
                            <div class="card-body">
                                <div class="table-wrap">
                                    <table class="table">
                                        <thead>
                                            <tr><th>#</th><th>User</th><th>Level</th><th>Rank</th><th>Lines</th><th>VP</th><th>PowerUp</th><th>Matching</th><th>Total</th></tr>
                                        </thead>
                                        <tbody id="pu-earners"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Placeholder -->
                    <div class="placeholder" id="pu-placeholder">
                        <div class="placeholder-icon">‚ö°</div>
                        <h3>PowerUp Bonus Simulation</h3>
                        <p>Configure parameters and click "Run Simulation" to model PowerUp and Matching bonus payouts.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- DIRECT BONUS PAGE -->
        <!-- ============================================ -->
        <div class="page" id="page-direct">
            <div class="layout">
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="card">
                        <div class="card-body">
                            <!-- Hierarchy Status -->
                            <div class="hierarchy-status" id="db-hierarchy-status">
                                <div class="hierarchy-status-title">üìä Hierarchy Status</div>
                                <div class="hierarchy-status-value" id="db-hierarchy-info">Not loaded</div>
                                <div class="hierarchy-status-sub" id="db-hierarchy-sub">Run PowerUp first or configure below</div>
                            </div>

                            <div class="tabs">
                                <button class="tab active" onclick="switchTab('db', 'basic')">Basic</button>
                                <button class="tab" onclick="switchTab('db', 'nlk')">NLK</button>
                                <button class="tab" onclick="switchTab('db', 'usdn')">USDN</button>
                                <button class="tab" onclick="switchTab('db', 'cascade')">Cascade</button>
                            </div>

                            <!-- Basic Tab -->
                            <div class="tab-content active" id="db-tab-basic">
                                <div class="info-box blue">
                                    <div class="info-box-title">üìà If No Hierarchy Loaded</div>
                                    <div class="info-box-text">Configure hierarchy to generate (or run PowerUp first)</div>
                                    <div class="form-row" style="margin-top: 12px; margin-bottom: 0;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Total Users</label>
                                            <input type="number" class="form-input" id="db_total_users" value="10000">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Max Depth</label>
                                            <input type="number" class="form-input" id="db_max_depth" value="7">
                                        </div>
                                    </div>
                                    <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; margin-top: 8px; cursor: pointer;">
                                        <input type="checkbox" id="db_use_cache" checked style="width: 14px; height: 14px;">
                                        Use CSV cache if available
                                    </label>
                                </div>

                                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 12px; margin-top: 12px;">
                                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px;">Growth Model (Logistic S-Curve)</div>
                                    <div class="form-row" style="margin-bottom: 0;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Growth Rate</label>
                                            <input type="number" class="form-input" id="db_growth_rate" value="0.8" step="0.1">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Peak Month</label>
                                            <input type="number" class="form-input" id="db_growth_midpoint" value="4.5" step="0.5">
                                        </div>
                                    </div>
                                </div>

                                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 12px; margin-top: 12px;">
                                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px;">Program Participation %</div>
                                    <div class="form-row" style="margin-bottom: 8px;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">NLK Only</label>
                                            <input type="number" class="form-input" id="db_nlk_only" value="40">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">USDN Only</label>
                                            <input type="number" class="form-input" id="db_usdn_only" value="20">
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Both Programs</label>
                                        <input type="number" class="form-input" id="db_both" value="40">
                                    </div>
                                </div>
                            </div>

                            <!-- NLK Tab -->
                            <div class="tab-content" id="db-tab-nlk">
                                <div class="info-box green">
                                    <div class="info-box-title">üíö NLK Direct Bonus</div>
                                    <div class="info-box-text">Sponsor receives 15% (first 30 days) or 10% (after)</div>
                                    <div class="form-row" style="margin-top: 12px; margin-bottom: 8px;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Promo Rate %</label>
                                            <input type="number" class="form-input" id="db_nlk_promo_rate" value="15">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Standard Rate %</label>
                                            <input type="number" class="form-input" id="db_nlk_std_rate" value="10">
                                        </div>
                                    </div>
                                    <div class="form-row" style="margin-bottom: 0;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Promo Days</label>
                                            <input type="number" class="form-input" id="db_nlk_promo_days" value="30">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Unit Price $</label>
                                            <input type="number" class="form-input" id="db_nlk_price" value="25">
                                        </div>
                                    </div>
                                </div>
                                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 12px; margin-top: 12px;">
                                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px;">Addition Behavior</div>
                                    <div class="form-row" style="margin-bottom: 0;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Avg Units</label>
                                            <input type="number" class="form-input" id="db_nlk_avg" value="8">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Promo Months</label>
                                            <input type="text" class="form-input" id="db_nlk_promos" value="1,2" placeholder="e.g. 1,2">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- USDN Tab -->
                            <div class="tab-content" id="db-tab-usdn">
                                <div class="info-box blue">
                                    <div class="info-box-title">üíô USDN Direct Bonus</div>
                                    <div class="info-box-text">3-level structure. Must have ‚â•2500 USDN to be eligible.</div>
                                    <div class="form-row" style="margin-top: 12px; margin-bottom: 8px;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">L1 Rate %</label>
                                            <input type="number" class="form-input" id="db_usdn_l1" value="7" step="0.5">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">L2 Rate %</label>
                                            <input type="number" class="form-input" id="db_usdn_l2" value="1.5" step="0.5">
                                        </div>
                                    </div>
                                    <div class="form-row" style="margin-bottom: 0;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">L3 Rate %</label>
                                            <input type="number" class="form-input" id="db_usdn_l3" value="1.5" step="0.5">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Eligibility $</label>
                                            <input type="number" class="form-input" id="db_usdn_elig" value="2500">
                                        </div>
                                    </div>
                                </div>
                                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 12px; margin-top: 12px;">
                                    <div class="form-row" style="margin-bottom: 0;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Avg Amount $</label>
                                            <input type="number" class="form-input" id="db_usdn_avg" value="500">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Promo Months</label>
                                            <input type="text" class="form-input" id="db_usdn_promos" value="2,3,4">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Cascade Tab -->
                            <div class="tab-content" id="db-tab-cascade">
                                <div class="info-box purple">
                                    <div class="info-box-title">üîÑ Reinvestment Cascade</div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <input type="checkbox" id="db_cascade_enabled" checked style="width: 16px; height: 16px;">
                                        <span style="font-size: 13px;">Enable cascade tracking</span>
                                    </div>
                                    <div class="info-box-text">20% of bonus paid as USDN can be reinvested, generating bonus-on-bonus.</div>
                                    <div class="form-row" style="margin-top: 12px; margin-bottom: 8px;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Reinvest Rate %</label>
                                            <input type="number" class="form-input" id="db_reinvest_rate" value="100">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">Stop Threshold $</label>
                                            <input type="number" class="form-input" id="db_cascade_stop" value="1">
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Reinvest Into</label>
                                        <select class="form-input" id="db_reinvest_program">
                                            <option value="random">Random (50/50)</option>
                                            <option value="nlk">NLK Only</option>
                                            <option value="usdn">USDN Only</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 12px; margin-top: 12px;">
                                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px;">Distribution Split</div>
                                    <div class="form-row" style="margin-bottom: 0;">
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">USDN-W %</label>
                                            <input type="number" class="form-input" id="db_usdn_w" value="80">
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label class="form-label">USDN %</label>
                                            <input type="number" class="form-input" id="db_usdn_r" value="20">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <button class="btn" id="db-run-btn" onclick="runDirectBonus()">üöÄ Run Direct Bonus Simulation</button>
                                <button class="btn" id="db-cancel-btn" onclick="cancelDirectBonus()" style="background: var(--orange); display: none;">‚èπ Cancel</button>
                                <button class="btn" id="db-reset-btn" onclick="forceReset('direct')" style="background: var(--text-secondary); display: none;">üîÑ Reset</button>
                            </div>
                            <div class="status-bar" id="db-status" style="display: none;">
                                <span id="db-status-text">Ready</span>
                                <span id="db-status-time" style="margin-left: 8px; opacity: 0.8;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="main">
                    <div class="results" id="db-results">
                        <!-- Methodology -->
                        <div class="methodology">
                            <h4>üìä Scientific Methodology</h4>
                            <div class="methodology-item"><strong>User Growth:</strong> Logistic S-curve (Rogers' Diffusion of Innovations) - models adoption lifecycle</div>
                            <div class="methodology-item"><strong>Addition Behavior:</strong> 30% monthly, 20% quarterly, 50% one-time (behavioral economics)</div>
                            <div class="methodology-item"><strong>NLK Direct:</strong> L1 sponsor receives 15%/10% split 80% USDN-W / 20% USDN</div>
                            <div class="methodology-item"><strong>USDN Direct:</strong> 3-level (7%/1.5%/1.5%) with 2500 USDN eligibility threshold</div>
                            <div class="methodology-item"><strong>Cascade:</strong> Reinvestment generates bonus-on-bonus until below threshold</div>
                        </div>

                        <!-- Hierarchy Info -->
                        <div id="db-result-hierarchy" style="background: var(--bg-secondary); border-radius: 10px; padding: 12px 16px; margin-bottom: 24px; display: flex; align-items: center; gap: 16px;">
                            <span style="font-size: 20px;">üìä</span>
                            <div>
                                <div style="font-size: 14px; font-weight: 600;" id="db-result-hierarchy-text">Hierarchy: 100,000 users √ó 15 levels</div>
                                <div style="font-size: 12px; color: var(--text-secondary);" id="db-result-hierarchy-source">Source: PowerUp simulation</div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Inflow</div>
                                <div class="stat-value" id="db-stat-inflow">$0</div>
                                <div class="stat-sub"><span id="db-stat-nlk-in">$0</span> NLK ¬∑ <span id="db-stat-usdn-in">$0</span> USDN</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Direct Bonus</div>
                                <div class="stat-value green" id="db-stat-bonus">$0</div>
                                <div class="stat-sub"><span id="db-stat-nlk-b">$0</span> NLK ¬∑ <span id="db-stat-usdn-b">$0</span> USDN</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Payout Ratio</div>
                                <div class="stat-value" id="db-stat-ratio">0%</div>
                                <div class="stat-sub">Direct Bonus / Inflow</div>
                            </div>
                        </div>

                        <div class="stats-grid four">
                            <div class="stat-card">
                                <div class="stat-label">NLK Payout Ratio</div>
                                <div class="stat-value green" id="db-stat-nlk-ratio">0%</div>
                                <div class="stat-sub">NLK Bonus / NLK Inflow</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">USDN Payout Ratio</div>
                                <div class="stat-value blue" id="db-stat-usdn-ratio">0%</div>
                                <div class="stat-sub">USDN Bonus / USDN Inflow</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Cascade (Reinvestment)</div>
                                <div class="stat-value purple" id="db-stat-cascade-pct">0%</div>
                                <div class="stat-sub" id="db-stat-cascade-info">$0 from reinvested bonuses</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">USDN Disqualified</div>
                                <div class="stat-value orange" id="db-stat-disq-pct">0%</div>
                                <div class="stat-sub" id="db-stat-disq-info">$0 (uplines not eligible)</div>
                            </div>
                        </div>

                        <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="stat-card">
                                <div class="stat-label">USDN Eligible Users</div>
                                <div class="stat-value" id="db-stat-elig">0</div>
                                <div class="stat-sub" id="db-stat-elig-pct">0% of users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Combined Payout Ratio</div>
                                <div class="stat-value" id="db-stat-combined-ratio">0%</div>
                                <div class="stat-sub">Total Bonus / Total Inflow</div>
                            </div>
                        </div>

                        <!-- Monthly Chart -->
                        <div class="chart-container">
                            <div class="chart-title">Monthly Inflow vs Bonus Payout</div>
                            <div class="chart-bars" id="db-chart"></div>
                            <div class="chart-legend">
                                <div class="legend-item"><div class="legend-dot" style="background: var(--blue);"></div> Inflow</div>
                                <div class="legend-item"><div class="legend-dot" style="background: var(--green);"></div> Bonus</div>
                            </div>
                        </div>

                        <!-- Monthly Table -->
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header"><h3>Monthly Breakdown - Payout Percentages</h3></div>
                            <div class="card-body">
                                <div class="table-wrap">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Month</th>
                                                <th>Users</th>
                                                <th>NLK %</th>
                                                <th>USDN L1 %</th>
                                                <th>USDN L2 %</th>
                                                <th>USDN L3 %</th>
                                                <th>Disq %</th>
                                                <th>Total %</th>
                                            </tr>
                                        </thead>
                                        <tbody id="db-monthly"></tbody>
                                    </table>
                                </div>
                                <details style="margin-top: 16px;">
                                    <summary style="cursor: pointer; color: var(--blue); font-weight: 500;">View Full Amount Details</summary>
                                    <div class="table-wrap" style="margin-top: 12px;">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Month</th>
                                                    <th>NLK In</th>
                                                    <th>USDN In</th>
                                                    <th>NLK Bonus</th>
                                                    <th>USDN Bonus</th>
                                                    <th>Cascade</th>
                                                    <th>Total Bonus</th>
                                                    <th>Disqualified</th>
                                                </tr>
                                            </thead>
                                            <tbody id="db-monthly-amounts"></tbody>
                                        </table>
                                    </div>
                                </details>
                            </div>
                        </div>

                        <!-- Top Earners -->
                        <div class="card">
                            <div class="card-header"><h3>üèÜ Top Direct Bonus Earners</h3></div>
                            <div class="card-body">
                                <div class="table-wrap">
                                    <table class="table">
                                        <thead>
                                            <tr><th>#</th><th>User</th><th>Level</th><th>Joined</th><th>NLK</th><th>USDN</th><th>Total</th><th>USDN-W</th><th>Eligible</th></tr>
                                        </thead>
                                        <tbody id="db-earners"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Placeholder -->
                    <div class="placeholder" id="db-placeholder">
                        <div class="placeholder-icon">üí∞</div>
                        <h3>Direct Bonus Simulation</h3>
                        <p>Simulates 12-month NLK and USDN direct bonus payouts with reinvestment cascade tracking.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function fmt(v) {
            if (v === undefined || v === null || isNaN(v)) return '$0';
            if (v >= 1e9) return '$' + (v/1e9).toFixed(2) + 'B';
            if (v >= 1e6) return '$' + (v/1e6).toFixed(2) + 'M';
            if (v >= 1e3) return '$' + (v/1e3).toFixed(1) + 'K';
            return '$' + v.toFixed(0);
        }
        function num(v) { return (v || 0).toLocaleString(); }
        function pct(v) { return (v || 0).toFixed(2) + '%'; }

        // Page Navigation
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.page-nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            event.target.classList.add('active');
            if (page === 'direct') updateHierarchyStatus();
        }

        // Tab Switching
        function switchTab(prefix, tab) {
            const container = document.getElementById('page-' + (prefix === 'pu' ? 'powerup' : 'direct'));
            container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(prefix + '-tab-' + tab).classList.add('active');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initPowerUpForm();
            updateHierarchyStatus();
        });

        function initPowerUpForm() {
            const ranks = ['N1','N2','N3','N4','N5','N6','N7'];
            const vpReqs = [5000, 15000, 30000, 100000, 250000, 500000, 1000000];
            const matchPcts = [0, 0, 10, 12.5, 15, 20, 25];

            // Rank inputs
            let rankHtml = '';
            ranks.forEach((r, i) => {
                rankHtml += `<div class="form-group"><label class="form-label">${r} VP Requirement</label>
                    <input type="number" class="form-input" id="rank_${r}" value="${vpReqs[i]}"></div>`;
            });
            document.getElementById('rank-inputs').innerHTML = rankHtml;

            // Matching inputs
            let matchHtml = '';
            ranks.forEach((r, i) => {
                matchHtml += `<div class="form-group"><label class="form-label">${r} Matching %</label>
                    <input type="number" class="form-input" id="match_${r}" value="${matchPcts[i]}" step="0.5"></div>`;
            });
            document.getElementById('matching-inputs').innerHTML = matchHtml;

            // PowerUp matrix
            const puMatrix = {
                'N1': [3,5,5,5,5], 'N2': [4,6,6,6,6], 'N3': [5,8,10,10,10],
                'N4': [6,11,13,15,15], 'N5': [7,13,15,17,19], 'N6': [8,14,17,19,21], 'N7': [9,15,19,21,23]
            };
            let puHtml = '<table style="width:100%; font-size:12px;"><tr><th></th>';
            for (let l = 1; l <= 5; l++) puHtml += `<th style="text-align:center; padding:8px;">${l}L</th>`;
            puHtml += '</tr>';
            ranks.forEach(r => {
                puHtml += `<tr><td style="font-weight:600; padding:8px;">${r}</td>`;
                puMatrix[r].forEach((v, i) => {
                    puHtml += `<td style="padding:4px;"><input type="number" class="form-input" id="pu_${r}_${i+1}" value="${v}" style="text-align:center; padding:6px;"></td>`;
                });
                puHtml += '</tr>';
            });
            puHtml += '</table>';
            document.getElementById('powerup-matrix').innerHTML = puHtml;
        }

        async function updateHierarchyStatus() {
            try {
                const res = await fetch('/api/hierarchy-status');
                const status = await res.json();
                const infoEl = document.getElementById('db-hierarchy-info');
                const subEl = document.getElementById('db-hierarchy-sub');
                
                if (status.loaded) {
                    infoEl.textContent = `${num(status.total_users)} users √ó ${status.max_depth} levels`;
                    subEl.textContent = `Loaded from: ${status.source || 'cache'}`;
                    infoEl.style.color = 'var(--green)';
                } else {
                    infoEl.textContent = 'Not loaded';
                    subEl.textContent = 'Will generate using config below';
                    infoEl.style.color = 'var(--text)';
                }
            } catch (e) {
                console.error('Failed to get hierarchy status:', e);
            }
        }

        // ============================================
        // POWERUP SIMULATION
        // ============================================
        function buildPowerUpConfig() {
            const config = {
                total_users: parseInt(document.getElementById('total_users').value),
                max_depth: parseInt(document.getElementById('max_depth').value),
                avg_units: parseInt(document.getElementById('avg_units').value),
                min_units: parseInt(document.getElementById('min_units').value),
                promotion_enabled: document.getElementById('promotion_enabled').checked,
                promotion_target_units: parseInt(document.getElementById('promotion_target').value),
                promotion_intensity: parseInt(document.getElementById('promotion_intensity').value),
                use_hierarchy_cache: document.getElementById('use_cache').checked,
                force_regenerate_hierarchy: document.getElementById('force_regenerate').checked,
                line_thresholds: {
                    2: parseFloat(document.getElementById('line_2').value) / 100,
                    3: parseFloat(document.getElementById('line_3').value) / 100,
                    4: parseFloat(document.getElementById('line_4').value) / 100,
                    5: parseFloat(document.getElementById('line_5').value) / 100
                },
                rank_vp_requirements: {},
                powerup_matrix: {},
                matching_percentages: {}
            };

            ['N1','N2','N3','N4','N5','N6','N7'].forEach(r => {
                config.rank_vp_requirements[r] = parseInt(document.getElementById('rank_' + r).value);
                config.matching_percentages[r] = parseFloat(document.getElementById('match_' + r).value) / 100;
                config.powerup_matrix[r] = {};
                for (let l = 1; l <= 5; l++) {
                    config.powerup_matrix[r][l] = parseFloat(document.getElementById(`pu_${r}_${l}`).value) / 100;
                }
            });

            return config;
        }

        // Format elapsed time as MM:SS
        function formatTime(seconds) {
            if (!seconds && seconds !== 0) return '';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Cancel PowerUp simulation
        async function cancelPowerUp() {
            try {
                await fetch('/api/cancel-simulation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type: 'powerup'})
                });
            } catch (e) {
                console.error('Cancel error:', e);
            }
        }

        // Cancel Direct Bonus simulation
        async function cancelDirectBonus() {
            try {
                await fetch('/api/cancel-simulation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type: 'direct'})
                });
            } catch (e) {
                console.error('Cancel error:', e);
            }
        }

        // Force reset stuck state
        async function forceReset(type) {
            try {
                await fetch('/api/force-reset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                // Reset UI
                if (type === 'powerup') {
                    document.getElementById('pu-run-btn').disabled = false;
                    document.getElementById('pu-run-btn').textContent = 'üöÄ Run Simulation';
                    document.getElementById('pu-status').style.display = 'none';
                    document.getElementById('pu-cancel-btn').style.display = 'none';
                    document.getElementById('pu-reset-btn').style.display = 'none';
                } else {
                    document.getElementById('db-run-btn').disabled = false;
                    document.getElementById('db-run-btn').textContent = 'üöÄ Run Direct Bonus Simulation';
                    document.getElementById('db-status').style.display = 'none';
                    document.getElementById('db-cancel-btn').style.display = 'none';
                    document.getElementById('db-reset-btn').style.display = 'none';
                }
                alert('State reset successfully. You can try again.');
            } catch (e) {
                console.error('Reset error:', e);
            }
        }

        async function runPowerUp() {
            const btn = document.getElementById('pu-run-btn');
            const cancelBtn = document.getElementById('pu-cancel-btn');
            const resetBtn = document.getElementById('pu-reset-btn');
            const status = document.getElementById('pu-status');
            const statusText = document.getElementById('pu-status-text');
            const statusTime = document.getElementById('pu-status-time');
            
            btn.disabled = true;
            btn.textContent = 'Running...';
            cancelBtn.style.display = 'inline-block';
            resetBtn.style.display = 'none';
            status.style.display = 'block';
            status.style.color = 'var(--text-secondary)';
            statusText.textContent = 'Starting...';
            statusTime.textContent = '';

            try {
                const config = buildPowerUpConfig();
                const res = await fetch('/api/run-simulation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                if (!res.ok) throw new Error((await res.json()).error);

                const poll = async () => {
                    const s = await (await fetch('/api/status')).json();
                    statusText.textContent = s.status;
                    if (s.elapsed_seconds !== undefined) {
                        statusTime.textContent = `(${formatTime(s.elapsed_seconds)})`;
                    }
                    
                    if (s.running) {
                        setTimeout(poll, 500);
                    } else if (s.error) {
                        throw new Error(s.error);
                    } else if (s.status === 'Cancelled') {
                        statusText.textContent = 'Cancelled';
                        btn.disabled = false;
                        btn.textContent = 'üöÄ Run Simulation';
                        cancelBtn.style.display = 'none';
                        setTimeout(() => { status.style.display = 'none'; }, 2000);
                    } else if (s.results) {
                        displayPowerUpResults(s.results);
                        btn.disabled = false;
                        btn.textContent = 'üöÄ Run Simulation';
                        cancelBtn.style.display = 'none';
                        status.style.display = 'none';
                        document.getElementById('pu-placeholder').style.display = 'none';
                        document.getElementById('pu-results').classList.add('visible');
                        updateHierarchyStatus();
                    }
                };
                setTimeout(poll, 500);
            } catch (e) {
                statusText.textContent = 'Error: ' + e.message;
                status.style.color = 'var(--red)';
                btn.disabled = false;
                btn.textContent = 'üöÄ Run Simulation';
                cancelBtn.style.display = 'none';
                resetBtn.style.display = 'inline-block';
            }
        }

        function displayPowerUpResults(r) {
            console.log('PowerUp Results:', r);  // Debug
            
            // Handle potential field name variations
            const totalUsers = r.total_users || 0;
            const totalSales = r.total_purchase_amount || r.total_sales || 0;
            const payoutRatio = r.payout_ratio || (r.total_earnings && totalSales ? (r.total_earnings / totalSales * 100) : 0);
            const totalPowerup = r.total_powerup || r.powerup_total || 0;
            const totalMatching = r.total_matching || r.matching_total || 0;
            const totalEarnings = r.total_earnings || (totalPowerup + totalMatching);
            const avgVp = r.avg_vp || r.average_vp || 0;

            document.getElementById('pu-stat-users').textContent = num(totalUsers);
            document.getElementById('pu-stat-sales').textContent = fmt(totalSales);
            document.getElementById('pu-stat-ratio').textContent = pct(payoutRatio);
            document.getElementById('pu-stat-powerup').textContent = fmt(totalPowerup);
            document.getElementById('pu-stat-matching').textContent = fmt(totalMatching);
            document.getElementById('pu-stat-total').textContent = fmt(totalEarnings);
            document.getElementById('pu-stat-vp').textContent = fmt(avgVp);

            // Rank distribution
            const rankDiv = document.getElementById('pu-rank-dist');
            rankDiv.innerHTML = '';
            const rankDist = r.rank_distribution || {};
            const ranks = ['N7','N6','N5','N4','N3','N2','N1','No Rank'];
            const maxRank = Math.max(...Object.values(rankDist), 1);
            ranks.forEach(rank => {
                const c = rankDist[rank] || 0;
                const w = (c / maxRank * 100);
                rankDiv.innerHTML += `<div class="dist-row">
                    <div class="dist-label">${rank}</div>
                    <div class="dist-bar"><div class="dist-fill blue" style="width:${w}%"></div></div>
                    <div class="dist-value">${num(c)}</div>
                </div>`;
            });

            // Line distribution
            const lineDiv = document.getElementById('pu-line-dist');
            lineDiv.innerHTML = '';
            const lineDist = r.line_distribution || {};
            const maxLine = Math.max(...Object.values(lineDist), 1);
            for (let i = 5; i >= 0; i--) {
                const c = lineDist[i] || 0;
                const w = (c / maxLine * 100);
                lineDiv.innerHTML += `<div class="dist-row">
                    <div class="dist-label">${i}L</div>
                    <div class="dist-bar"><div class="dist-fill green" style="width:${w}%"></div></div>
                    <div class="dist-value">${num(c)}</div>
                </div>`;
            }

            // Heatmap
            const heatmapDiv = document.getElementById('pu-heatmap');
            if (r.powerup_matrix_heatmap) {
                const hm = r.powerup_matrix_heatmap;
                let html = '<table class="heatmap-table"><tr><th></th>';
                for (let l = 1; l <= 5; l++) html += `<th>${l} Line${l>1?'s':''}</th>`;
                html += '</tr>';
                
                // Order N1 to N7 (ascending)
                ['N1','N2','N3','N4','N5','N6','N7'].forEach(rank => {
                    html += `<tr><th>${rank}</th>`;
                    for (let l = 1; l <= 5; l++) {
                        const cell = hm[rank]?.[l];
                        if (cell && cell.user_count > 0) {
                            const int = cell.intensity || 0;
                            const bg = `rgb(${Math.round(245-int*200)}, ${Math.round(245-int*46)}, ${Math.round(247-int*158)})`;
                            const fg = int > 0.5 ? 'white' : (int > 0.2 ? 'var(--text)' : 'var(--text-secondary)');
                            // Fix: percentage is already in decimal form (0.09 = 9%), multiply by 100 once
                            const pctVal = (cell.percentage || 0);
                            const displayPct = pctVal > 1 ? pctVal : pctVal * 100; // Handle both formats
                            html += `<td><div class="heatmap-cell" style="background:${bg}; color:${fg};">
                                <div class="heatmap-pct">${displayPct.toFixed(0)}%</div>
                                <div class="heatmap-amount">${fmt(cell.total_earned || 0)}</div>
                                <div class="heatmap-users">${num(cell.user_count)} users</div>
                            </div></td>`;
                        } else {
                            html += `<td><div class="heatmap-cell" style="background:var(--bg-secondary); color:var(--text-tertiary);">‚Äî</div></td>`;
                        }
                    }
                    html += '</tr>';
                });
                html += '</table>';
                heatmapDiv.innerHTML = html;
            } else {
                heatmapDiv.innerHTML = '<p style="color:var(--text-secondary); text-align:center;">Heatmap data not available</p>';
            }

            // Top earners
            const tbody = document.getElementById('pu-earners');
            tbody.innerHTML = '';
            const topEarners = r.top_earners || [];
            topEarners.slice(0, 15).forEach((e, i) => {
                const rc = i < 3 ? `rank-${i+1}` : 'rank-other';
                const bc = e.rank ? `badge-${e.rank.toLowerCase()}` : '';
                tbody.innerHTML += `<tr>
                    <td><span class="rank-num ${rc}">${i+1}</span></td>
                    <td>#${e.user_id || 0}</td>
                    <td>L${e.level || 0}</td>
                    <td><span class="badge ${bc}">${e.rank || '‚Äî'}</span></td>
                    <td>${e.lines || e.qualified_lines || 0}</td>
                    <td class="money">${fmt(e.total_vp || 0)}</td>
                    <td class="money">${fmt(e.powerup_earned || e.total_powerup_earned || 0)}</td>
                    <td class="money">${fmt(e.matching_earned || e.total_matching_earned || 0)}</td>
                    <td class="money" style="font-weight:600;">${fmt(e.total_earned || (e.powerup_earned || 0) + (e.matching_earned || 0))}</td>
                </tr>`;
            });

            document.getElementById('pu-results').scrollIntoView({behavior:'smooth'});
        }

        // ============================================
        // DIRECT BONUS SIMULATION
        // ============================================
        function buildDirectBonusConfig() {
            const parseMonths = (str) => str.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
            
            return {
                hierarchy_total_users: parseInt(document.getElementById('db_total_users').value),
                hierarchy_max_depth: parseInt(document.getElementById('db_max_depth').value),
                use_hierarchy_cache: document.getElementById('db_use_cache').checked,
                growth_rate: parseFloat(document.getElementById('db_growth_rate').value),
                growth_midpoint: parseFloat(document.getElementById('db_growth_midpoint').value),
                nlk_only_pct: parseFloat(document.getElementById('db_nlk_only').value) / 100,
                usdn_only_pct: parseFloat(document.getElementById('db_usdn_only').value) / 100,
                both_programs_pct: parseFloat(document.getElementById('db_both').value) / 100,
                nlk_promo_rate: parseFloat(document.getElementById('db_nlk_promo_rate').value) / 100,
                nlk_standard_rate: parseFloat(document.getElementById('db_nlk_std_rate').value) / 100,
                nlk_promo_days: parseInt(document.getElementById('db_nlk_promo_days').value),
                nlk_unit_price: parseInt(document.getElementById('db_nlk_price').value),
                nlk_avg_units: parseInt(document.getElementById('db_nlk_avg').value),
                nlk_promo_months: parseMonths(document.getElementById('db_nlk_promos').value),
                usdn_l1_rate: parseFloat(document.getElementById('db_usdn_l1').value) / 100,
                usdn_l2_rate: parseFloat(document.getElementById('db_usdn_l2').value) / 100,
                usdn_l3_rate: parseFloat(document.getElementById('db_usdn_l3').value) / 100,
                usdn_eligibility_threshold: parseInt(document.getElementById('db_usdn_elig').value),
                usdn_avg_amount: parseInt(document.getElementById('db_usdn_avg').value),
                usdn_promo_months: parseMonths(document.getElementById('db_usdn_promos').value),
                enable_reinvestment: document.getElementById('db_cascade_enabled').checked,
                reinvestment_rate: parseFloat(document.getElementById('db_reinvest_rate').value) / 100,
                cascade_stop_threshold: parseFloat(document.getElementById('db_cascade_stop').value),
                reinvestment_program: document.getElementById('db_reinvest_program').value,
                usdn_w_pct: parseFloat(document.getElementById('db_usdn_w').value) / 100,
                usdn_pct: parseFloat(document.getElementById('db_usdn_r').value) / 100
            };
        }

        async function runDirectBonus() {
            const btn = document.getElementById('db-run-btn');
            const cancelBtn = document.getElementById('db-cancel-btn');
            const resetBtn = document.getElementById('db-reset-btn');
            const status = document.getElementById('db-status');
            const statusText = document.getElementById('db-status-text');
            const statusTime = document.getElementById('db-status-time');
            
            btn.disabled = true;
            btn.textContent = 'Running...';
            cancelBtn.style.display = 'inline-block';
            resetBtn.style.display = 'none';
            status.style.display = 'block';
            status.style.color = 'var(--text-secondary)';
            statusText.textContent = 'Starting...';
            statusTime.textContent = '';

            try {
                const config = buildDirectBonusConfig();
                const res = await fetch('/api/run-direct-bonus', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                if (!res.ok) throw new Error((await res.json()).error);

                const poll = async () => {
                    const s = await (await fetch('/api/direct-bonus-status')).json();
                    statusText.textContent = s.status;
                    if (s.elapsed_seconds !== undefined) {
                        statusTime.textContent = `(${formatTime(s.elapsed_seconds)})`;
                    }
                    
                    if (s.running) {
                        setTimeout(poll, 500);
                    } else if (s.error) {
                        throw new Error(s.error);
                    } else if (s.status === 'Cancelled') {
                        statusText.textContent = 'Cancelled';
                        btn.disabled = false;
                        btn.textContent = 'üöÄ Run Direct Bonus Simulation';
                        cancelBtn.style.display = 'none';
                        setTimeout(() => { status.style.display = 'none'; }, 2000);
                    } else if (s.results) {
                        displayDirectBonusResults(s.results);
                        btn.disabled = false;
                        btn.textContent = 'üöÄ Run Direct Bonus Simulation';
                        cancelBtn.style.display = 'none';
                        status.style.display = 'none';
                        document.getElementById('db-placeholder').style.display = 'none';
                        document.getElementById('db-results').classList.add('visible');
                        updateHierarchyStatus();
                    }
                };
                setTimeout(poll, 500);
            } catch (e) {
                statusText.textContent = 'Error: ' + e.message;
                status.style.color = 'var(--red)';
                btn.disabled = false;
                btn.textContent = 'üöÄ Run Direct Bonus Simulation';
                cancelBtn.style.display = 'none';
                resetBtn.style.display = 'inline-block';
            }
        }

        function displayDirectBonusResults(data) {
            console.log('Direct Bonus Results:', data);  // Debug
            
            const s = data.summary || {};
            const m = data.monthly || [];
            const h = data.hierarchy_info || {};

            // Hierarchy info
            document.getElementById('db-result-hierarchy-text').textContent = 
                `Hierarchy: ${num(h.total_users || 0)} users √ó ${h.max_depth || 0} levels`;
            document.getElementById('db-result-hierarchy-source').textContent = 
                `Source: ${h.source || 'unknown'}`;

            // Summary stats
            document.getElementById('db-stat-inflow').textContent = fmt(s.total_inflow || 0);
            document.getElementById('db-stat-nlk-in').textContent = fmt(s.nlk_inflow || 0);
            document.getElementById('db-stat-usdn-in').textContent = fmt(s.usdn_inflow || 0);
            document.getElementById('db-stat-bonus').textContent = fmt(s.total_bonus || 0);
            document.getElementById('db-stat-nlk-b').textContent = fmt(s.nlk_bonus || 0);
            document.getElementById('db-stat-usdn-b').textContent = fmt(s.usdn_bonus || 0);
            document.getElementById('db-stat-ratio').textContent = pct(s.payout_ratio || 0);
            
            // Per-program payout ratios
            document.getElementById('db-stat-nlk-ratio').textContent = pct(s.nlk_payout_ratio || 0);
            document.getElementById('db-stat-usdn-ratio').textContent = pct(s.usdn_payout_ratio || 0);
            
            // Cascade bonus - show as % of total inflow
            const cascadePct = s.total_inflow > 0 ? ((s.cascade_bonus || 0) / s.total_inflow * 100) : 0;
            document.getElementById('db-stat-cascade-pct').textContent = cascadePct.toFixed(2) + '%';
            document.getElementById('db-stat-cascade-info').textContent = 
                fmt(s.cascade_bonus || 0) + ' from reinvested bonuses';
            
            // Disqualified - show as % of USDN inflow
            const disqPct = s.usdn_inflow > 0 ? ((s.disqualified || 0) / s.usdn_inflow * 100) : 0;
            document.getElementById('db-stat-disq-pct').textContent = disqPct.toFixed(1) + '%';
            document.getElementById('db-stat-disq-info').textContent = 
                fmt(s.disqualified || 0) + ' (uplines not eligible)';
            
            document.getElementById('db-stat-elig').textContent = num(s.usdn_eligible_users || 0);
            document.getElementById('db-stat-elig-pct').textContent = (s.usdn_eligible_pct || 0).toFixed(1) + '% of users';
            
            // Combined payout ratio (fixed - uses different ID now)
            document.getElementById('db-stat-combined-ratio').textContent = pct(s.payout_ratio || 0);

            // Chart
            const chartDiv = document.getElementById('db-chart');
            chartDiv.innerHTML = '';
            if (m.length > 0) {
                const maxVal = Math.max(...m.map(x => Math.max(x.inflow || 0, x.total_bonus || 0)), 1);
                m.forEach(month => {
                    const inflowH = ((month.inflow || 0) / maxVal * 140);
                    const bonusH = ((month.total_bonus || 0) / maxVal * 140);
                    chartDiv.innerHTML += `<div class="chart-bar-group">
                        <div class="chart-bar-pair">
                            <div class="chart-bar inflow" style="height:${inflowH}px;" title="Inflow: ${fmt(month.inflow || 0)}"></div>
                            <div class="chart-bar bonus" style="height:${bonusH}px;" title="Bonus: ${fmt(month.total_bonus || 0)}"></div>
                        </div>
                        <div class="chart-label">M${month.month}</div>
                    </div>`;
                });
            }

            // Monthly table - Percentages
            const config = buildDirectBonusConfig();
            const nlkPromo = config.nlk_promo_months || [];
            const usdnPromo = config.usdn_promo_months || [];
            const tbody = document.getElementById('db-monthly');
            tbody.innerHTML = '';
            m.forEach(month => {
                const isPromo = nlkPromo.includes(month.month) || usdnPromo.includes(month.month);
                tbody.innerHTML += `<tr class="${isPromo ? 'promo-row' : ''}">
                    <td>M${month.month} ${isPromo ? 'üéØ' : ''}</td>
                    <td>${num(month.new_users || 0)}</td>
                    <td style="color:var(--green); font-weight:600;">${(month.nlk_payout_pct || 0).toFixed(1)}%</td>
                    <td style="color:var(--blue);">${(month.usdn_l1_pct || 0).toFixed(2)}%</td>
                    <td style="color:var(--blue);">${(month.usdn_l2_pct || 0).toFixed(2)}%</td>
                    <td style="color:var(--blue);">${(month.usdn_l3_pct || 0).toFixed(2)}%</td>
                    <td style="color:var(--orange);">${(month.usdn_disq_pct || 0).toFixed(1)}%</td>
                    <td style="font-weight:600;">${(month.payout_ratio || 0).toFixed(1)}%</td>
                </tr>`;
            });

            // Monthly table - Amounts (in details)
            const amountsTbody = document.getElementById('db-monthly-amounts');
            amountsTbody.innerHTML = '';
            m.forEach(month => {
                const isPromo = nlkPromo.includes(month.month) || usdnPromo.includes(month.month);
                amountsTbody.innerHTML += `<tr class="${isPromo ? 'promo-row' : ''}">
                    <td>M${month.month}</td>
                    <td class="money">${fmt(month.nlk_inflow || 0)}</td>
                    <td class="money">${fmt(month.usdn_inflow || 0)}</td>
                    <td class="money" style="color:var(--green);">${fmt(month.nlk_bonus || 0)}</td>
                    <td class="money" style="color:var(--blue);">${fmt(month.usdn_bonus || 0)}</td>
                    <td class="money" style="color:var(--purple);">${fmt(month.cascade_bonus || 0)}</td>
                    <td class="money" style="font-weight:600;">${fmt(month.total_bonus || 0)}</td>
                    <td class="money" style="color:var(--orange);">${fmt(month.disqualified || 0)}</td>
                </tr>`;
            });

            // Top earners
            const earners = document.getElementById('db-earners');
            earners.innerHTML = '';
            const topEarners = data.top_earners || [];
            topEarners.slice(0, 15).forEach((e, i) => {
                const rc = i < 3 ? `rank-${i+1}` : 'rank-other';
                const eligBadge = e.is_usdn_eligible 
                    ? '<span class="badge badge-n3">‚úì</span>' 
                    : '<span class="badge">‚Äî</span>';
                earners.innerHTML += `<tr>
                    <td><span class="rank-num ${rc}">${i+1}</span></td>
                    <td>#${e.user_id || 0}</td>
                    <td>L${e.level || 0}</td>
                    <td>M${e.join_month || 0}</td>
                    <td class="money" style="color:var(--green);">${fmt(e.nlk_bonus || 0)}</td>
                    <td class="money" style="color:var(--blue);">${fmt(e.usdn_bonus || 0)}</td>
                    <td class="money" style="font-weight:600;">${fmt(e.total_bonus || 0)}</td>
                    <td class="money">${fmt(e.usdn_w_received || 0)}</td>
                    <td>${eligBadge}</td>
                </tr>`;
            });

            document.getElementById('db-results').scrollIntoView({behavior:'smooth'});
        }
    </script>
</body>
</html>